

default_platform(:ios)

platform :ios do
before_all do
    ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "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"
  end
  
  desc "Push a new beta build to TestFlight"
  lane :beta do
  
   
    clear_derived_data
    app_store_connect_api_key(key_id: "JX9V5MKAZ8",
    issuer_id: "69a6de7b-64f7-47e3-e053-5b8c7c11a4d1",
    key_content: "-----BEGIN PRIVATE KEY-----
MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgqY+zMlaE2wxUF52V
sVjXSHAJCTBazoVfb6XYH7/cztWgCgYIKoZIzj0DAQehRANCAAR92PmRoyK13ll/
r/QsbuQCywYT06REWJ0g33iVMaJSQTuuAyHyFakF3uSVAD2qC1+Nd8Tf2qu96vAq
8ZLOS6eJ
-----END PRIVATE KEY-----")

    opt_out_usage
  
    gym(
        scheme: "GitHubCICD",
        output_directory: ".",
        archive_path:".",
        configuration: "Release",
        export_method: "app-store",
      )
      
    setup_ci
    increment_build_number(xcodeproj: "GitHubCICD.xcodeproj")
    

    build_app(
      workspace: "GitHubCICD.xcworkspace",
      scheme: "GitHubCICD",
      export_xcargs: "-allowProvisioningUpdates",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM='#{ENV["327TPG23FM"]}'",
      export_team_id: ENV["327TPG23FM"],
      output_directory: "deploy",
      output_name: "#{ENV["FILE_IPA"]}-#{GitHubCICD}.ipa",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "#{ENV["APPLICATION_ID"]}" => "match AppStore com.CICD",
        }
      }
    )
    
    upload_to_testflight(skip_waiting_for_build_processing: true)
    
  end
end
