

default_platform(:ios)

platform :ios do
before_all do
    ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "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"
  end
  
  desc "Push a new beta build to TestFlight"
  lane :beta do
  
   
    clear_derived_data
    app_store_connect_api_key(key_id: "JX9V5MKAZ8",
    issuer_id: "2054974",
    key_content: "-----BEGIN PRIVATE KEY-----
MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgqY+zMlaE2wxUF52V
sVjXSHAJCTBazoVfb6XYH7/cztWgCgYIKoZIzj0DAQehRANCAAR92PmRoyK13ll/
r/QsbuQCywYT06REWJ0g33iVMaJSQTuuAyHyFakF3uSVAD2qC1+Nd8Tf2qu96vAq
8ZLOS6eJ
-----END PRIVATE KEY-----")

    opt_out_usage

  
   match(
   skip_certificate_matching : true
   )
    gym(
        scheme: "GitHubCICD",
        output_directory: ".",
        archive_path:".",
        configuration: "Release",
        export_method: "app-store",
        export_options: {
          provisioningProfiles: {
            "com.CICD" => "match AppStore_com.CICD.mobileprovision"
          }
        }
      )
      
    setup_ci
    increment_build_number(xcodeproj: "GitHubCICD.xcodeproj")
    build_app
    upload_to_testflight(skip_waiting_for_build_processing: true)
    
  end
end
